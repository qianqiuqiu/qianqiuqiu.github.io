<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RL Homework Refactoring</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="data.js"></script>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">RL Homework Refactoring</div>
    <div class="nav-item active" onclick="showModule('environment')">Environment</div>
    <div class="nav-item" onclick="showModule('reward')">Reward</div>
    <div class="nav-item" onclick="showModule('policy')">Policy</div>
    <div class="nav-item" onclick="showModule('optimality')">Optimality Equation</div>
    <div class="nav-item" onclick="showModule('qlearning')">Q-Learning</div>
    <div class="nav-item" onclick="showModule('tdlinear')">TD Linear</div>
</div>

<div id="content">
    <!-- Environment Module -->
    <div id="mod-environment" class="module">
        <h2>Environment</h2>
        <div class="card">
            <div id="env-grid" class="grid-container"></div>
            <div class="legend">
                <div class="legend-item"><div class="legend-box" style="background:#fff"></div> Normal</div>
                <div class="legend-item"><div class="legend-box" style="background:#000"></div> Forbidden</div>
                <div class="legend-item"><div class="legend-box" style="background:#0d6efd"></div> Target</div>
            </div>
        </div>
    </div>

    <!-- Reward Module -->
    <div id="mod-reward" class="module hidden">
        <h2>Reward Configuration</h2>
        <div class="card">
            <p>Select the penalty for forbidden states:</p>
            <div class="controls">
                <label><input type="radio" name="reward" value="-1" checked onchange="updateReward(this.value)"> -1</label>
                <label style="margin-left: 20px;"><input type="radio" name="reward" value="-10" onchange="updateReward(this.value)"> -10</label>
            </div>
            <p><em>Note: Changing this will affect the results in Optimality, Q-Learning, and TD Linear modules.</em></p>
        </div>
    </div>

    <!-- Policy Module -->
    <div id="mod-policy" class="module hidden">
        <h2>Policy Configuration</h2>
        <div class="card">
            <div class="controls">
                <button onclick="setPolicyPreset('random')">Random</button>
                <button onclick="setPolicyPreset('up')">Up Only</button>
                <button onclick="setPolicyPreset('right')">Right Only</button>
            </div>
            <p>Click on cells to cycle actions (这个修改只对当前页面下方的 "Evaluate Policy"（策略评估）按钮生效):</p>
            <div id="policy-grid" class="grid-container"></div>
            <div class="controls" style="margin-top: 20px;">
                <button onclick="evaluatePolicy()">Evaluate Policy </button>
            </div>
            <div id="policy-eval-result" class="grid-container"></div>
        </div>
    </div>

    <!-- Optimality Equation Module -->
    <div id="mod-optimality" class="module hidden">
        <h2>Optimality Equation</h2>
        
        <!-- Convergence Analysis Chart -->
        <div class="card">
            <h3>Convergence Analysis (PI vs Truncated PI)</h3>
            <div style="height: 300px; width: 100%;">
                <canvas id="convergenceChart"></canvas>
            </div>
            <div class="controls" style="margin-top: 15px;">
                <label>Truncation Steps (k) for TPI(修改它也会影响下面TPI可视化的迭代次数):</label>
                <div class="btn-group">
                    <button class="tpi-k-tab active" onclick="switchTPIK('3')">3</button>
                    <button class="tpi-k-tab" onclick="switchTPIK('9')">9</button>
                    <button class="tpi-k-tab" onclick="switchTPIK('27')">27</button>
                    <button class="tpi-k-tab" onclick="switchTPIK('81')">81</button>
                </div>
            </div>
        </div>

        <!-- Visualization Controls -->
        <div class="card">
            <h3>Step-by-Step Visualization</h3>
            <div class="btn-group">
                <button class="opt-tab active" onclick="switchOptTab('vi')">Value Iteration</button>
                <button class="opt-tab" onclick="switchOptTab('pi')">Policy Iteration</button>
                <button class="opt-tab" onclick="switchOptTab('tpi')">Truncated PI</button>
            </div>

            <div class="controls">
                <label>Iteration: <span id="iter-display">0</span></label>
                <input type="range" id="iter-slider" min="0" max="0" value="0" oninput="updateOptimalityView()">
            </div>

            <div style="display: flex; gap: 40px; justify-content: center;">
                <div>
                    <h4>Policy</h4>
                    <div id="opt-policy-grid" class="grid-container"></div>
                </div>
                <div>
                    <h4>Value Function</h4>
                    <div id="opt-value-grid" class="grid-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Q-Learning Module -->
    <div id="mod-qlearning" class="module hidden">
        <h2>Q-Learning</h2>
        <div class="card">
            <div class="controls">
                <label>Epsilon:</label>
                <div class="btn-group">
                    <button class="q-tab active" onclick="switchQTab('0.1')">0.1</button>
                    <button class="q-tab" onclick="switchQTab('0.2')">0.2</button>
                    <button class="q-tab" onclick="switchQTab('0.5')">0.5</button>
                </div>
            </div>

            <div style="display: flex; gap: 40px; justify-content: center;">
                <div>
                    <h4>Final Policy</h4>
                    <div id="q-policy-grid" class="grid-container"></div>
                </div>
                <div>
                    <h4>Final Value</h4>
                    <div id="q-value-grid" class="grid-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- TD Linear Module -->
    <div id="mod-tdlinear" class="module hidden">
        <h2>TD Linear</h2>
        <div class="card">
            <p><em>Note: 傅里叶变换阶数越高，结果越精确，但计算量也越大。此处展示初始策略为随机的预计算结果。</em></p>
            
            <div class="controls">
                <label>Polynomial Order:</label>
                <div class="btn-group">
                    <button class="td-tab active" onclick="switchTDTab('poly_1')">1</button>
                    <button class="td-tab" onclick="switchTDTab('poly_2')">2</button>
                    <button class="td-tab" onclick="switchTDTab('poly_3')">3</button>
                </div>
                <label>Fourier Order:</label>
                <div class="btn-group">
                    <button class="td-tab" onclick="switchTDTab('fourier_1')">1</button>
                    <button class="td-tab" onclick="switchTDTab('fourier_2')">2</button>
                    <button class="td-tab" onclick="switchTDTab('fourier_3')">3</button>
                </div>
            </div>

            <div style="display: flex; justify-content: center;">
                <div style="width: 100%; max-width: 600px;">
                    <h4>Value Function Approximation</h4>
                    <div id="td-value-plot" style="width: 100%; height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="script.js"></script>
</body>
</html>
